---
title: "Loan Repayment and borrower analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
```{r, include = FALSE}
libs <- c("dplyr", "tidyr", "data.table", "ggplot2", "caret", "caTools")
lapply(libs, require, character.only = T)
```
# Loading Data
```{r cars}
data <- fread("data/loan_data.csv") %>% 
        mutate(not.fully.paid = factor(ifelse(not.fully.paid == 1, "Yes", "No")),
               credit.policy = factor(ifelse(credit.policy == 1, "Yes", "No")),
               annual.inc = exp(log.annual.inc),
               days = round(data$days.with.cr.line))

```

| Variable  | class     | description                    |
|:----------|:----------|:-------------------------------|
| credit_policy   | numeric | 1 if the customer meets the credit underwriting criteria; 0 otherwise. |
| purpose      | character | The purpose of the loan. |
| int_rate      | numeric   | The interest rate of the loan (more risky borrowers are assigned higher interest rates).  |
| installment  | numeric   | The monthly installments owed by the borrower if the loan is funded. |
| log_annual_inc | numeric   | The natural log of the self-reported annual income of the borrower. |
| dti | numeric   | The debt-to-income ratio of the borrower (amount of debt divided by annual income). |
| fico | numeric   | The FICO credit score of the borrower. |
| days_with_cr_line | numeric   | The number of days the borrower has had a credit line. |
| revol_bal | numeric   | The borrower's revolving balance (amount unpaid at the end of the credit card billing cycle). |
| revol_util | numeric   | The borrower's revolving line utilization rate (the amount of the credit line used relative to total credit available). |
| inq_last_6mths | numeric   | The borrower's number of inquiries by creditors in the last 6 months. |
| delinq_2yrs | numeric   | The number of times the borrower had been 30+ days past due on a payment in the past 2 years. |
| pub_rec | numeric   | The borrower's number of derogatory public records.
| not_fully_paid | numeric   | 1 if the loan is not fully paid; 0 otherwise.

# Exploratory Data Analysis
## Exploring Possible response variables
### Examining fully paid 
```{r}
data %>%
ggplot(aes(x = factor(not.fully.paid), fill = not.fully.paid)) +
  geom_bar() +
  labs(x = "Default", y = "Count", title = "Number of Clients who did and did not Default") +
  theme_minimal() +
  theme(legend.position = "none")

fully_paid_prop <- data %>%
  summarize(prop = mean(not.fully.paid == "No")) %>%
  pull()

Counts <- data %>%
  count(not.fully.paid)
```

  When looking at the number of people who defaulted (did not completely pay off the loan) on their loan, there is a significant difference between the number of individuals who have paid off their loans completely vs those who defaulted on it. With around `r fully_paid_prop*100`% (`r Counts[1,2]`) paying off their loans completely and around `r (1-fully_paid_prop)*100`% (`r Counts[2,2]`) defaulting on their loans, this as a response variable is unbalanced and will require balancing during the prediction process. 


### Examining days with credit line
```{r}
data %>% 
  ggplot(aes(x = days.with.cr.line, color = factor(not.fully.paid))) +
  geom_histogram() +
  labs(x = "Days with Credit Line", y = "Count", title = "Histogram of Days with Credit Line by Defaults", color = "Default") +
  theme_minimal()
```

```{r}
data %>% 
  ggplot(aes(x = days.with.cr.line, color = factor(purpose))) +
  geom_histogram() +
  labs(x = "Days with Credit Line", y = "Count", title = "Histogram of Days with Credit Line by Purpose", color = "Purpose") +
  scale_color_discrete(labels = c("Other", "Credit Card", "Debt Consolidation", "Educational", "Home Improvement", "Major Purchase", "Small Business")) +
  theme_minimal()
```
##
```{r}
ggplot(data, aes(factor(pub.rec), fico, fill = factor(pub.rec))) +
  geom_boxplot()

```


```{r}
data %>% 
  ggplot(aes(x = fico, y = days.with.cr.line, color = factor(not.fully.paid))) +
  geom_point() +
  geom_smooth(method = "loess")
```

##
```{r}
data %>% 
  ggplot(aes(x = revol.util, y = fico, color = not.fully.paid)) +
  geom_point() +
  geom_smooth(method = "lm")
```


```{r}
data %>% 
  ggplot(aes(x = dti, y = days.with.cr.line, color = factor(not.fully.paid))) +
  geom_point() +
  geom_smooth(method = "lm")
```


##
```{r}
data %>%
  ggplot(aes(x = log.annual.inc, y = days.with.cr.line, color = dti)) +
  geom_point() +
  geom_smooth(method = "loess", color = "red") +
  geom_smooth(method = "lm")

```

# Poisson Regression
## Estimating Days with credit line based on character traits
```{r}
# Variables of interest: 
##
plot(log(days) ~ fico, data = data)
plot((1/days) ~ int.rate, data = data)
summary(pois_reg <- glm(days ~ int.rate*fico + I(int.rate^2) + log.annual.inc, data = data, family = "Gamma"))
test_data <- data[runif(500, min = 0, max = nrow(data)),]
pred <- predict(pois_reg, newdata = test_data, type = "response")
actual <- test_data[,days.with.cr.line]

pchisq(pois_reg$deviance, pois_reg$df.residual, lower.tail=F)

plot(pois_reg)
plot(pred, actual)
hist(pred)
hist(actual)
```




# Cluster Analysis and Dimensionality reduction
```{r}
summary(pr <- prcomp(data[,c("fico", "revol.util", "days.with.cr.line", "dti")], scale = T))
biplot(pr)
km1 <- kmeans(scaled, centers = 3, nstart = 1000)
plot(data$fico, data$days.with.cr.line , col = km1$cluster)
```

```{r}
(pr <- prcomp(data[,c(3,6,7,9,10)], scale = T))
summary(pr)
biplot(pr)
plot(pr$x[,c(1,2)], col = as.factor(data$not.fully.paid))
plot(pr$x[,c(1,3)], col = as.factor(data$not.fully.paid))
plot(pr$x[,c(2,3)], col = as.factor(data$not.fully.paid))

km1 <- kmeans(pr$x[,1:3], centers = 3, nstart = 1000)
plot(pr$x[,1:2], col = km1$cluster)
table(km1$cluster, data$not.fully.paid)
```

```{r}
(pr <- prcomp(data[,c(3,6,7,9,10)], scale = T))
summary(pr)
biplot(pr)
plot(pr$x[,c(1,2)], col = as.factor(data$not.fully.paid))
plot(pr$x[,c(1,3)], col = as.factor(data$not.fully.paid))
plot(pr$x[,c(2,3)], col = as.factor(data$not.fully.paid))

km1 <- kmeans(pr$x[,1:3], centers = 3, nstart = 1000)
plot(pr$x[,1:2], col = km1$cluster)
table(km1$cluster, data$not.fully.paid)
```

# Binomial Models and Linear Models
```{r}
full_paid_data <- data %>%
                filter(not.fully.paid == 0) %>%
                select(-not.fully.paid)

lm(days.with.cr.line ~ fico*dti, data = data) %>% summary()
lm(days.with.cr.line ~ log.annual.inc + poly(fico, 3), data = data) %>% summary()
```

```{r}
data %>%
  ggplot(aes(x = fico, y = int.rate, color = factor(not.fully.paid))) +
  geom_point() +
  geom_smooth(method = "lm")

summary(fico_int_model <- glm(formula = not.fully.paid ~ fico*int.rate, data = data, family = "binomial"))
```


# Machine Learning Prediction Models using Caret
```{r}
set.seed(0)
ind <- sample(nrow(data), size = round(nrow(data)*.8))
train <- data[ind,]
test <- data[-ind,]

ctrl <- trainControl(method = "repeatedcv", repeats = 5,
                     classProbs = TRUE,
                     summaryFunction = twoClassSummary,
                     sampling = "down")

gbm <- train(not.fully.paid ~ .,
             data = train,
             method = "gbm",
             metric = "ROC",
             verbose = F,
             trControl = ctrl) 

probs <- predict(gbm, test, type = "prob")
preds <- ifelse(probs[1] > .50, "No", "Yes")
table(preds, test$credit.policy)
```